---
// Globe Analytics - Figma-level Minimal Design
---

<section class="globe-section animate delay-4">
    <h2>visitors</h2>
    
    <!-- Greeting Banner -->
    <div class="visitor-welcome" id="visitor-welcome">
        <span class="welcome-emoji">üëã</span>
        <span class="welcome-text">Hey there, welcome! <strong id="visitor-city"></strong></span>
    </div>

    <!-- Stats - Minimal inline -->
    <div class="stats-row">
        <div class="stat">
            <span id="stat-visits" class="stat-num">--</span>
            <span class="stat-text">visits</span>
        </div>
        <div class="stat">
            <span id="stat-locations" class="stat-num">--</span>
            <span class="stat-text">cities</span>
        </div>
        <div class="stat">
            <span id="stat-countries" class="stat-num">--</span>
            <span class="stat-text">countries</span>
        </div>
        <div class="stat live">
            <span class="live-dot"></span>
            <span id="stat-live" class="stat-num">0</span>
            <span class="stat-text">live</span>
        </div>
    </div>

    <!-- Globe with Effects -->
    <div class="globe-universe">
        <div class="globe-aurora"></div>
        <div class="globe-particles" id="globe-particles"></div>
        <div class="globe-container">
            <div id="globe-canvas">
                <div class="loader-wrap">
                    <div class="loader-dot"></div>
                </div>
            </div>
        </div>
        <div class="globe-ticker" id="globe-ticker">
            <span class="ticker-dot"></span>
            <span class="ticker-text" id="ticker-text">Watching the world...</span>
        </div>
    </div>
    
    <!-- Confetti Container -->
    <div class="confetti-box" id="confetti-box"></div>

    <!-- Recent Activity - Inline minimal -->
    <div class="inline-section activity-section">
        <div class="inline-label">
            <span class="label-icon">‚óâ</span> Recent Activity
            <span class="live-badge" id="live-badge"></span>
        </div>
        <div class="inline-row" id="activity-list">
            <span class="inline-empty">Waiting for visitors...</span>
        </div>
    </div>

    <!-- Top Countries - Inline minimal -->
    <div class="inline-section countries-section">
        <div class="inline-label">
            <span class="label-icon">‚óà</span> Top Countries
            <span class="total-badge" id="total-countries-badge"></span>
        </div>
        <div class="inline-row" id="countries-list">
            <span class="inline-empty">Loading...</span>
        </div>
    </div>
</section>

<style is:global>
    .globe-section {
        margin-bottom: 3rem;
    }

    .globe-section h2 {
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        font-weight: 700;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .globe-section h2::after {
        content: '';
        height: 1px;
        flex: 1;
        background: linear-gradient(to right, var(--border), transparent);
    }

    /* Welcome Banner */
    .visitor-welcome {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.6rem 1.2rem;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.6));
        border: 1px solid rgba(255, 255, 255, 0.8);
        border-radius: 50px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.05);
        backdrop-filter: blur(12px);
        opacity: 0;
        transform: translateY(-10px);
        animation: welcomeIn 0.6s ease-out 0.8s forwards;
    }

    @keyframes welcomeIn {
        to { opacity: 1; transform: translateY(0); }
    }

    .welcome-emoji {
        font-size: 1.2rem;
        animation: waveHand 2s ease-in-out infinite;
    }

    @keyframes waveHand {
        0%, 100% { transform: rotate(0deg); }
        15% { transform: rotate(14deg); }
        30% { transform: rotate(-8deg); }
        45% { transform: rotate(14deg); }
        60% { transform: rotate(-4deg); }
        75%, 100% { transform: rotate(0deg); }
    }

    .welcome-text {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .welcome-text strong {
        color: var(--text);
        font-weight: 600;
    }

    /* Globe Universe */
    .globe-universe {
        position: relative;
        margin-bottom: 3rem;
    }

    .globe-aurora {
        position: absolute;
        inset: -20%;
        background: conic-gradient(
            from 0deg at 50% 50%,
            transparent 0deg,
            rgba(34, 197, 94, 0.04) 60deg,
            rgba(59, 130, 246, 0.03) 120deg,
            rgba(168, 85, 247, 0.03) 180deg,
            rgba(236, 72, 153, 0.02) 240deg,
            rgba(34, 197, 94, 0.03) 300deg,
            transparent 360deg
        );
        animation: auroraRotate 40s linear infinite;
        pointer-events: none;
        filter: blur(60px);
        border-radius: 50%;
    }

    @keyframes auroraRotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .globe-particles {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
    }

    .particle {
        position: absolute;
        width: 3px;
        height: 3px;
        background: rgba(220, 38, 38, 0.5);
        border-radius: 50%;
        animation: particleFly 6s ease-out infinite;
    }

    @keyframes particleFly {
        0% { transform: translateY(0) scale(0); opacity: 0; }
        10% { opacity: 1; transform: scale(1); }
        100% { transform: translateY(-150px) scale(0); opacity: 0; }
    }

    .globe-ticker {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background: rgba(0, 0, 0, 0.02);
        border-radius: 8px;
    }

    .ticker-dot {
        width: 6px;
        height: 6px;
        background: #22c55e;
        border-radius: 50%;
        animation: tickerPulse 2s ease-in-out infinite;
    }

    @keyframes tickerPulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
        50% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
    }

    .ticker-text {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    /* Confetti */
    .confetti-box {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 9999;
        overflow: hidden;
    }

    .confetti-piece {
        position: absolute;
        width: 10px;
        height: 10px;
        animation: confettiFall 3s ease-out forwards;
    }

    @keyframes confettiFall {
        0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
        100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* Stats Row - Ultra minimal */
    .stats-row {
        display: flex;
        gap: 3rem;
        margin-bottom: 3rem;
        flex-wrap: wrap;
    }

    .stat {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
    }

    .stat.live {
        position: relative;
        padding-left: 1rem;
    }

    .live-dot {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 6px;
        height: 6px;
        background: #22c55e;
        border-radius: 50%;
        animation: livePulse 2s ease-in-out infinite;
    }

    @keyframes livePulse {
        0%, 100% {
            opacity: 1;
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
        }
        50% {
            opacity: 0.7;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0);
        }
    }

    .stat-num {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 2rem;
        font-weight: 600;
        color: var(--text);
        line-height: 1;
        font-variant-numeric: tabular-nums;
    }

    .stat.live .stat-num {
        color: #22c55e;
    }

    .stat-text {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    /* Globe */
    .globe-container {
        width: 100%;
        max-width: 650px;
        margin: 0 auto 3rem;
        aspect-ratio: 1;
    }

    #globe-canvas {
        width: 100%;
        height: 100%;
    }

    .loader-wrap {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .loader-dot {
        width: 8px;
        height: 8px;
        background: var(--text-muted);
        border-radius: 50%;
        animation: loaderPulse 1.2s ease-in-out infinite;
    }

    @keyframes loaderPulse {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.5); }
    }

    #globe-canvas.loaded .loader-wrap {
        display: none;
    }

    /* Inline Sections - Refined with glass effect */
    .inline-section {
        margin-bottom: 2rem;
        padding: 1.25rem 1.5rem;
        border-radius: 16px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.3));
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    .activity-section {
        border-left: 3px solid #22c55e;
    }

    .countries-section {
        border-left: 3px solid var(--accent-red);
    }

    .inline-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-muted);
        font-weight: 700;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .label-icon {
        font-size: 0.6rem;
        opacity: 0.5;
    }

    .activity-section .label-icon {
        color: #22c55e;
        opacity: 1;
    }

    .countries-section .label-icon {
        color: var(--accent-red);
        opacity: 1;
    }

    .live-badge {
        font-size: 0.65rem;
        font-weight: 700;
        color: #22c55e;
        background: rgba(34, 197, 94, 0.12);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        margin-left: 0.3rem;
        display: none;
        align-items: center;
        gap: 0.3rem;
    }

    .live-badge.visible {
        display: inline-flex;
    }

    .live-badge::before {
        content: '';
        width: 5px;
        height: 5px;
        background: #22c55e;
        border-radius: 50%;
        animation: pulseDot 2s ease-out infinite;
    }

    .total-badge {
        font-size: 0.65rem;
        font-weight: 600;
        color: var(--text-muted);
        background: rgba(0, 0, 0, 0.05);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        margin-left: 0.3rem;
        display: none;
    }

    .total-badge.visible {
        display: inline-block;
    }

    .inline-label::after {
        content: '';
        height: 1px;
        flex: 1;
        background: linear-gradient(to right, var(--border), transparent 50%);
    }

    .inline-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0;
        align-items: center;
    }

    .inline-empty {
        color: var(--text-faint);
        font-size: 0.9rem;
        font-style: italic;
    }

    /* Activity Items - Clean with separators */
    .activity-item {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0;
        position: relative;
        transition: all 0.2s ease;
        animation: fadeSlideIn 0.4s ease-out backwards;
    }

    .activity-item:nth-child(1) { animation-delay: 0s; }
    .activity-item:nth-child(2) { animation-delay: 0.05s; }
    .activity-item:nth-child(3) { animation-delay: 0.1s; }
    .activity-item:nth-child(4) { animation-delay: 0.15s; }
    .activity-item:nth-child(5) { animation-delay: 0.2s; }

    @keyframes fadeSlideIn {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .activity-item:not(:last-child)::after {
        content: '¬∑';
        color: var(--text-faint);
        margin: 0 1rem;
        font-size: 1.4rem;
        opacity: 0.3;
        font-weight: 300;
    }

    .activity-item:hover {
        opacity: 0.7;
    }

    .activity-item:first-child .activity-city {
        color: #22c55e;
    }

    .activity-city {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text);
        letter-spacing: -0.01em;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }

    .activity-flag {
        font-size: 0.9rem;
        line-height: 1;
    }

    .activity-sub {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .activity-time {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.75rem;
        color: var(--text-muted);
        font-family: 'Space Grotesk', monospace;
        background: rgba(0, 0, 0, 0.04);
        padding: 0.25rem 0.6rem;
        border-radius: 6px;
        font-weight: 500;
    }

    .activity-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #22c55e;
        display: inline-block;
        flex-shrink: 0;
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        animation: pulseDot 2s ease-out infinite;
    }

    .activity-dot.dot-soon {
        background: #f97316;
        box-shadow: 0 0 8px rgba(249, 115, 22, 0.5);
        animation: pulseDotOrange 2s ease-out infinite;
    }

    .activity-dot.dot-old {
        background: var(--text-faint);
        box-shadow: none;
        animation: none;
        opacity: 0.4;
    }

    @keyframes pulseDot {
        0%, 100% { 
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
            transform: scale(1);
        }
        50% { 
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
            transform: scale(1.2);
        }
    }

    @keyframes pulseDotOrange {
        0%, 100% { 
            box-shadow: 0 0 8px rgba(249, 115, 22, 0.5);
            transform: scale(1);
        }
        50% { 
            box-shadow: 0 0 12px rgba(249, 115, 22, 0.8);
            transform: scale(1.2);
        }
    }

    /* Country Items - Big numbers like stats */
    .country-item {
        display: inline-flex;
        align-items: baseline;
        gap: 0.4rem;
        padding: 0.3rem 0;
        transition: all 0.2s ease;
        animation: fadeSlideIn 0.4s ease-out backwards;
    }

    .country-item:nth-child(1) { animation-delay: 0s; }
    .country-item:nth-child(2) { animation-delay: 0.05s; }
    .country-item:nth-child(3) { animation-delay: 0.1s; }
    .country-item:nth-child(4) { animation-delay: 0.15s; }
    .country-item:nth-child(5) { animation-delay: 0.2s; }

    .country-item:not(:last-child)::after {
        content: '';
        width: 1px;
        height: 1.2rem;
        background: linear-gradient(to bottom, transparent, var(--border), transparent);
        margin: 0 1.3rem;
        align-self: center;
    }

    .country-item:hover {
        opacity: 0.7;
    }

    .country-rank {
        font-size: 0.7rem;
        color: var(--text-faint);
        font-weight: 600;
        min-width: 1.5rem;
    }

    .country-rank.rank-first {
        font-size: 0.9rem;
    }

    .country-count {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--text);
        line-height: 1;
        font-variant-numeric: tabular-nums;
        letter-spacing: -0.02em;
    }

    .country-item:first-child .country-count {
        color: var(--accent-red);
    }

    .country-label {
        font-size: 0.9rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .inline-section {
            padding: 1rem 1.25rem;
            border-radius: 12px;
        }

        .inline-row {
            gap: 0;
        }

        .activity-item:not(:last-child)::after {
            margin: 0 0.6rem;
            font-size: 1.2rem;
        }

        .country-item:not(:last-child)::after {
            margin: 0 0.8rem;
        }

        .country-count {
            font-size: 1.4rem;
        }

        .activity-city {
            font-size: 0.9rem;
        }

        .activity-time {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
        }
    }

    @media (max-width: 480px) {
        .inline-section {
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .inline-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0;
        }

        .activity-item:not(:last-child)::after,
        .country-item:not(:last-child)::after {
            display: none;
        }

        .activity-item,
        .country-item {
            width: 100%;
            justify-content: space-between;
            padding: 0.65rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .activity-item:last-child,
        .country-item:last-child {
            border-bottom: none;
        }
    }

    /* Tooltip - Minimal */
    :global(.scene-tooltip) {
        font-family: 'Inter', sans-serif !important;
        background: rgba(255, 255, 255, 0.98) !important;
        backdrop-filter: blur(8px) !important;
        color: var(--text) !important;
        padding: 8px 10px !important;
        border-radius: 6px !important;
        border: none !important;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08) !important;
        font-size: 13px !important;
        line-height: 1.4 !important;
    }

    /* Responsive */
    @media (max-width: 900px) {
        .analytics-grid {
            grid-template-columns: 1fr;
            gap: 2.5rem;
        }
    }

    @media (max-width: 768px) {
        .stats-row {
            gap: 2rem;
        }

        .stat-num {
            font-size: 1.6rem;
        }

        .globe-container {
            max-width: 400px;
        }

        .analytics-grid {
            gap: 1.5rem;
        }

        .analytics-panel {
            padding: 1.1rem 1.25rem;
        }
    }

    @media (max-width: 480px) {
        .stats-row {
            gap: 1.5rem;
        }

        .stat-num {
            font-size: 1.4rem;
        }

        .stat-text {
            font-size: 0.85rem;
        }

        .globe-container {
            max-width: 320px;
        }

        .activity-item, .country-item {
            padding: 0.75rem 0.9rem;
        }

        .activity-city, .country-name {
            font-size: 0.95rem;
        }

        .panel-title {
            font-size: 1rem;
        }

        .activity-time {
            font-size: 0.8rem;
        }
    }
</style>

<script is:inline>
(function() {
    var loaded = false;
    var live = 0;
    var activities = [];
    var countries = {};
    
    var countryNames = {
        "IN": "India", "US": "United States", "GB": "United Kingdom", "CA": "Canada",
        "AU": "Australia", "DE": "Germany", "FR": "France", "ES": "Spain", "IT": "Italy",
        "BR": "Brazil", "MX": "Mexico", "AR": "Argentina", "JP": "Japan", "CN": "China",
        "KR": "South Korea", "SG": "Singapore", "HK": "Hong Kong", "TH": "Thailand",
        "VN": "Vietnam", "ID": "Indonesia", "PH": "Philippines", "MY": "Malaysia",
        "PK": "Pakistan", "BD": "Bangladesh", "LK": "Sri Lanka", "NP": "Nepal",
        "AE": "UAE", "SA": "Saudi Arabia", "TR": "Turkey", "EG": "Egypt", "ZA": "South Africa",
        "NG": "Nigeria", "KE": "Kenya", "GH": "Ghana", "ET": "Ethiopia", "MA": "Morocco",
        "RU": "Russia", "PL": "Poland", "NL": "Netherlands", "BE": "Belgium", "CH": "Switzerland",
        "AT": "Austria", "SE": "Sweden", "NO": "Norway", "DK": "Denmark", "FI": "Finland",
        "IE": "Ireland", "PT": "Portugal", "GR": "Greece", "CZ": "Czech Republic", "RO": "Romania",
        "NZ": "New Zealand", "IL": "Israel", "CO": "Colombia", "CL": "Chile", "PE": "Peru",
        "KW": "Kuwait", "QA": "Qatar", "OM": "Oman"
    };

    function getName(code) {
        return countryNames[code] || code;
    }

    function getFlag(code) {
        if (!code || code.length !== 2) return '';
        var codePoints = code.toUpperCase().split('').map(function(c) {
            return 127397 + c.charCodeAt(0);
        });
        return String.fromCodePoint.apply(null, codePoints);
    }

    function animate(el, target) {
        if (!el || isNaN(target)) return;
        var current = 0;
        var duration = 800;
        var start = null;

        function step(ts) {
            if (!start) start = ts;
            var progress = Math.min((ts - start) / duration, 1);
            current = Math.floor(progress * target);
            el.textContent = current.toLocaleString();
            if (progress < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
    }

    function timeAgo(ms) {
        var s = Math.floor((Date.now() - ms) / 1000);
        if (s < 60) return 'now';
        if (s < 3600) return Math.floor(s / 60) + 'm';
        if (s < 86400) return Math.floor(s / 3600) + 'h';
        return Math.floor(s / 86400) + 'd';
    }

    function updateActivity() {
        var list = document.getElementById('activity-list');
        if (!list) return;

        if (activities.length === 0) {
            list.innerHTML = '<span class="inline-empty">Waiting for visitors...</span>';
            return;
        }

        list.innerHTML = activities.slice(0, 5).map(function(a) {
            var ageMs = Date.now() - a.time;
            var isLive = ageMs < 90000;
            var isSoon = ageMs < 300000;
            var label = timeAgo(a.time);
            var dotClass = isLive ? '' : (isSoon ? 'dot-soon' : 'dot-old');
            var flag = getFlag(a.country);
            return '<div class="activity-item">' +
                '<span class="activity-city">' + (a.city || 'Unknown') + ' <span class="activity-flag">' + flag + '</span></span>' +
                '<span class="activity-time">' +
                    '<span class="activity-dot ' + dotClass + '"></span>' +
                    label +
                '</span>' +
            '</div>';
        }).join('');
    }

    function updateCountries() {
        var list = document.getElementById('countries-list');
        if (!list) return;

        var sorted = Object.entries(countries)
            .sort(function(a, b) { return b[1] - a[1]; })
            .slice(0, 5);

        if (sorted.length === 0) {
            list.innerHTML = '<span class="inline-empty">Loading...</span>';
            return;
        }

        var totalCountries = Object.keys(countries).length;
        var badge = document.getElementById('total-countries-badge');
        if (badge) {
            badge.textContent = totalCountries + ' total';
            badge.classList.add('visible');
        }

        list.innerHTML = sorted.map(function(item, i) {
            var flag = getFlag(item[0]);
            var rank = i === 0 ? 'üëë' : '#' + (i + 1);
            var rankClass = i === 0 ? 'rank-first' : '';
            return '<div class="country-item">' +
                '<span class="country-rank ' + rankClass + '">' + rank + '</span>' +
                '<span class="country-count">' + item[1] + '</span>' +
                '<span class="country-label">' + flag + ' ' + getName(item[0]) + '</span>' +
            '</div>';
        }).join('');
    }

    function setLive(n) {
        var el = document.getElementById('stat-live');
        if (el) el.textContent = n;
        
        var badge = document.getElementById('live-badge');
        if (badge) {
            if (n > 0) {
                badge.textContent = n + ' live';
                badge.classList.add('visible');
            } else {
                badge.classList.remove('visible');
            }
        }
    }

    function updateTicker(city, country) {
        var ticker = document.getElementById('ticker-text');
        if (!ticker) return;
        var flag = getFlag(country);
        var messages = [
            flag + ' ' + city + ' just landed',
            'Someone from ' + city + ' ' + flag,
            flag + ' Hello from ' + city + '!',
            city + ' ' + flag + ' exploring...'
        ];
        ticker.textContent = messages[Math.floor(Math.random() * messages.length)];
    }

    function spawnConfetti() {
        var box = document.getElementById('confetti-box');
        if (!box) return;
        var colors = ['#22c55e', '#3b82f6', '#f59e0b', '#ec4899', '#8b5cf6'];
        for (var i = 0; i < 30; i++) {
            var piece = document.createElement('div');
            piece.className = 'confetti-piece';
            piece.style.left = Math.random() * 100 + '%';
            piece.style.background = colors[Math.floor(Math.random() * colors.length)];
            piece.style.animationDelay = Math.random() * 0.5 + 's';
            piece.style.transform = 'rotate(' + Math.random() * 360 + 'deg)';
            box.appendChild(piece);
            setTimeout(function(el) { el.remove(); }, 3500, piece);
        }
    }

    function createParticles() {
        var container = document.getElementById('globe-particles');
        if (!container) return;
        for (var i = 0; i < 15; i++) {
            var p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random() * 100 + '%';
            p.style.bottom = Math.random() * 30 + '%';
            p.style.animationDelay = Math.random() * 6 + 's';
            p.style.animationDuration = (4 + Math.random() * 4) + 's';
            container.appendChild(p);
        }
    }

    function loadScripts(cb) {
        if (loaded) return cb();
        var c = 0;
        function done() { if (++c === 2) { loaded = true; cb(); } }
        var s1 = document.createElement('script');
        s1.src = '//unpkg.com/globe.gl@2.45.0/dist/globe.gl.min.js';
        s1.async = true;
        s1.onload = done;
        document.head.appendChild(s1);
        var s2 = document.createElement('script');
        s2.src = '//unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js';
        s2.async = true;
        s2.onload = done;
        document.head.appendChild(s2);
    }

    function init() {
        var API = 'https://globe-analytics.alokgupta1560.workers.dev';
        var WS = 'wss://globe-analytics.alokgupta1560.workers.dev/ws';

        fetch(API + '/track').catch(function(){});

        var canvas = document.getElementById('globe-canvas');
        if (!canvas || typeof Globe === 'undefined') return;

        canvas.classList.add('loaded');

        function color(c) {
            var i = Math.min(1, c / 15);
            return 'rgba(' + Math.round(200 - i * 50) + ',' + Math.round(100 - i * 50) + ',' + Math.round(130 - i * 50) + ',0.8)';
        }

        var globe = Globe()(canvas)
            .backgroundColor('rgba(0,0,0,0)')
            .atmosphereColor('rgba(160,140,150,0.2)')
            .atmosphereAltitude(0.1)
            .showAtmosphere(true)
            .showGlobe(false)
            .polygonCapColor(function() { return 'rgba(150,130,140,0.4)'; })
            .polygonSideColor(function() { return 'rgba(170,150,160,0.2)'; })
            .polygonStrokeColor(function() { return 'rgba(255,255,255,0.4)'; })
            .polygonAltitude(0.002)
            .polygonsTransitionDuration(250)
            .arcColor(function() { return ['rgba(220,38,38,0.4)', 'rgba(220,38,38,0.05)']; })
            .arcAltitude(0.08)
            .arcStroke(0.25)
            .arcDashLength(0.6)
            .arcDashGap(0.2)
            .arcDashAnimateTime(1000)
            .arcsData([])
            .ringLat(function(d) { return d.lat; })
            .ringLng(function(d) { return d.lng; })
            .ringColor(function() { return function(t) { return 'rgba(220,38,38,' + (1-t)*0.3 + ')'; }; })
            .ringMaxRadius(2.5)
            .ringPropagationSpeed(1.2)
            .ringRepeatPeriod(2000)
            .ringAltitude(0.004)
            .ringsData([])
            .pointLat(function(d) { return d.lat; })
            .pointLng(function(d) { return d.lng; })
            .pointRadius(function(d) { return d.r; })
            .pointAltitude(function(d) { return d.a; })
            .pointColor(function(d) { return d.c; })
            .pointLabel(function(d) { return d.l; })
            .pointsData([]);

        fetch('//unpkg.com/world-atlas@2.0.2/countries-110m.json')
            .then(function(r) { return r.json(); })
            .then(function(d) {
                globe.polygonsData(topojson.feature(d, d.objects.countries).features);
            }).catch(function(){});

        globe.controls().autoRotate = true;
        globe.controls().autoRotateSpeed = 0.35;
        globe.controls().enableZoom = false;

        var speed = 0.35;
        canvas.addEventListener('mouseenter', function() { speed = 0; });
        canvas.addEventListener('mouseleave', function() { speed = 0.35; });
        setInterval(function() {
            var curr = globe.controls().autoRotateSpeed;
            var diff = speed - curr;
            if (Math.abs(diff) > 0.01) globe.controls().autoRotateSpeed = curr + diff * 0.08;
        }, 50);

        function resize() {
            var rect = canvas.getBoundingClientRect();
            globe.width(rect.width).height(rect.height);
        }
        resize();
        window.addEventListener('resize', resize);

        var pts = [];
        var livePts = [];
        var arcs = [];
        var myLat = 23.34, myLng = 85.31;

        function label(d, isLive) {
            return '<div style="line-height:1.5">' +
                '<div style="font-weight:600;margin-bottom:2px">' + (d.city || 'Unknown') + '</div>' +
                '<div style="color:#666;font-size:12px;margin-bottom:4px">' + getName(d.country) + '</div>' +
                '<div style="color:#999;font-size:11px;padding-top:4px;border-top:1px solid #eee">' +
                (isLive ? '<span style="color:#22c55e">‚óè Live</span>' : d.count + ' visits') +
                '</div></div>';
        }

        fetch(API + '/analytics')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!Array.isArray(data)) return;

                data.forEach(function(p) {
                    if (p.country) countries[p.country] = (countries[p.country] || 0) + (p.count || 1);
                    if (p.city) activities.push({ city: p.city, country: p.country, time: Date.now() - Math.random() * 3600000 });
                });

                activities.sort(function(a, b) { return b.time - a.time; });
                activities = activities.slice(0, 5);
                updateActivity();
                updateCountries();

                pts = data.map(function(p) {
                    var cnt = p.count || 1;
                    return {
                        lat: Number(p.lat), lng: Number(p.lng),
                        r: Math.min(0.35, 0.08 + cnt * 0.025),
                        a: Math.min(0.25, 0.008 + cnt * 0.018),
                        c: color(cnt),
                        l: label(p, false),
                        count: cnt
                    };
                });

                globe.pointsData(pts);
                globe.ringsData(pts.slice(0, 10).map(function(p) { return {lat: p.lat, lng: p.lng}; }));
            }).catch(function(){});

        fetch(API + '/stats')
            .then(function(r) { return r.json(); })
            .then(function(s) {
                animate(document.getElementById('stat-visits'), s.total_visits || 0);
                animate(document.getElementById('stat-locations'), s.unique_locations || 0);
                animate(document.getElementById('stat-countries'), s.countries || 0);
            }).catch(function(){});

        // Get visitor's location for welcome message
        fetch('https://ipapi.co/json/')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.city) {
                    var cityEl = document.getElementById('visitor-city');
                    var welcomeText = document.querySelector('.welcome-text');
                    if (cityEl && welcomeText) {
                        var flag = getFlag(data.country_code);
                        welcomeText.innerHTML = 'Hey, visiting from ' + flag + ' <strong>' + data.city + '</strong>?';
                    }
                }
            }).catch(function(){});

        // Create particles
        createParticles();

        try {
            var ws = new WebSocket(WS);

            ws.onmessage = function(e) {
                try {
                    var d = JSON.parse(e.data);
                    var lat = Number(d.lat), lng = Number(d.lng);
                    if (!isFinite(lat) || !isFinite(lng)) return;

                    live++;
                    setLive(live);

                    activities.unshift({ city: d.city, country: d.country, time: Date.now() });
                    activities = activities.slice(0, 5);
                    updateActivity();

                    // Update ticker and spawn confetti on new visitor
                    if (d.city) {
                        updateTicker(d.city, d.country);
                        spawnConfetti();
                    }

                    if (d.country) {
                        countries[d.country] = (countries[d.country] || 0) + 1;
                        updateCountries();
                    }

                    arcs.push({ startLat: lat, startLng: lng, endLat: myLat, endLng: myLng, ts: Date.now() });
                    globe.arcsData(arcs);

                    livePts.push({
                        lat: lat, lng: lng, ts: Date.now(),
                        r: 0.3, a: 0.1, c: '#22c55e',
                        l: label({city: d.city, country: d.country}, true)
                    });

                    globe.ringsData([...globe.ringsData(), {lat: lat, lng: lng}]);
                } catch(err) {}
            };

            ws.onclose = function() {
                live = Math.max(0, live - 1);
                setLive(live);
            };
        } catch(err) {}

        setInterval(function() {
            var now = Date.now();
            for (var i = arcs.length - 1; i >= 0; i--) {
                if (now - arcs[i].ts > 2000) arcs.splice(i, 1);
            }
            globe.arcsData(arcs);

            for (var j = livePts.length - 1; j >= 0; j--) {
                if (now - livePts[j].ts > 9000) livePts.splice(j, 1);
            }

            livePts.forEach(function(p) {
                var age = now - p.ts;
                var pulse = Math.sin(age / 200) * 0.5 + 0.5;
                var fade = Math.max(0, 1 - age / 9000);
                p.r = 0.2 + pulse * 0.2 * fade;
                p.a = 0.05 + pulse * 0.05 * fade;
            });

            globe.pointsData(pts.concat(livePts));
        }, 60);

        setInterval(updateActivity, 30000);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { loadScripts(init); });
    } else {
        loadScripts(init);
    }
})();
</script>
